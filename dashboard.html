<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard</title>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: Arial, sans-serif; max-width: 900px; margin: 20px auto; padding: 10px; }
    h1, h2 { text-align: center; }

    /* Top bar */
    #topbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 5px 15px;
    }

    /* Profile avatar */
    #profile {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background-color: #007bff;
      color: #fff;
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      font-weight: bold;
      font-size: 18px;
    }

    /* Dropdown menu */
    #settingsMenu {
      display: none;
      position: absolute;
      top: 60px;
      right: 20px;
      background: white;
      border: 1px solid #ccc;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      padding: 10px;
      min-width: 180px;
    }
    #settingsMenu button {
      width: 100%;
      margin: 5px 0;
      padding: 8px;
      border-radius: 5px;
      cursor: pointer;
    }

    /* File cards */
    .file-card { 
      border: 1px solid #ccc; 
      padding: 10px; 
      margin: 10px; 
      display: inline-block; 
      text-align: center; 
      width: 180px; 
      border-radius: 8px;
      box-shadow: 1px 1px 5px rgba(0,0,0,0.1);
    }
    img, video { max-width: 150px; max-height: 150px; display: block; margin: 0 auto 10px; border-radius: 4px; }
    button { padding: 6px 12px; margin: 5px; cursor: pointer; border-radius: 4px; }

    #cameraControls {
      text-align: center;
      margin-top: 10px;
      display: flex;
      justify-content: center;
      gap: 10px;
    }
    #camera {
      display: block;
      margin: 0 auto;
      border-radius: 8px;
    }
  </style>
</head>
<body>
  <!-- Top bar with title and profile -->
  <div id="topbar">
    <h1>Dashboard</h1>
    <div id="profile"></div>
  </div>

  <!-- Profile settings dropdown -->
  <div id="settingsMenu">
    <p id="userEmail" style="font-size:14px; margin:5px 0;"></p>
    <button id="backupBtn">Backup All Photos</button>
    <button id="logout">Logout</button>
  </div>

  <h2>Upload a File</h2>
  <input type="file" id="fileInput" />
  <button id="uploadBtn">Upload</button>

  <h2>Live Camera</h2>
  <video id="camera" autoplay playsinline width="320" height="240" style="border:1px solid #ccc; background:#000"></video>
  <canvas id="canvas" width="320" height="240" style="display:none;"></canvas>

  <div id="cameraControls">
    <button id="captureBtn">Take Picture</button>
    <button id="toggleCamera">Turn Camera On</button>
  </div>

  <h2>Your Files</h2>
  <div id="fileList"></div>

  <!-- Hidden input for backup -->
  <input type="file" id="backupInput" accept="image/*" multiple style="display:none;" />

  <script>
    const SUPABASE_URL = "https://ywivqcxjtvmztktwlepj.supabase.co";
    const SUPABASE_ANON_KEY = "YOUR_SUPABASE_KEY";
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true },
    });

    const profile = document.getElementById("profile");
    const settingsMenu = document.getElementById("settingsMenu");
    const userEmail = document.getElementById("userEmail");
    const logoutBtn = document.getElementById("logout");
    const backupBtn = document.getElementById("backupBtn");
    const backupInput = document.getElementById("backupInput");

    // Show profile circle + menu toggle
    profile.addEventListener("click", () => {
      settingsMenu.style.display = settingsMenu.style.display === "block" ? "none" : "block";
    });

    // Logout
    logoutBtn.addEventListener("click", async () => {
      await sb.auth.signOut();
      window.location.href = "login.html";
    });

    // Backup button opens file picker
    backupBtn.addEventListener("click", () => {
      backupInput.click();
    });

    // Upload multiple files from backup
    backupInput.addEventListener("change", async () => {
      const files = Array.from(backupInput.files);
      if (!files.length) return;

      const { data: { session } } = await sb.auth.getSession();
      if (!session) return alert("Not logged in");

      for (const file of files) {
        const path = `${session.user.id}/backup-${Date.now()}-${file.name}`;
        await sb.storage.from("user-uploads").upload(path, file);
      }

      alert("Backup complete!");
      loadFiles();
    });

    function sanitize(name) {
      return name.replace(/[^a-zA-Z0-9._-]/g, "_");
    }

    // Load files
    async function loadFiles() {
      const { data: { session } } = await sb.auth.getSession();
      if (!session) return;

      const { data } = await sb.storage.from("user-uploads").list(session.user.id, { limit: 100 });
      fileList.innerHTML = "";

      for (const file of data) {
        const { data: signed } = await sb.storage.from("user-uploads").createSignedUrl(`${session.user.id}/${file.name}`, 3600);

        const div = document.createElement("div");
        div.className = "file-card";

        if (file.name.match(/\.(jpg|jpeg|png|gif|webp)$/i)) {
          const img = document.createElement("img");
          img.src = signed?.signedUrl;
          div.appendChild(img);
        }

        const link = document.createElement("a");
        link.href = signed?.signedUrl || "#";
        link.textContent = file.name;
        link.target = "_blank";
        div.appendChild(link);

        const delBtn = document.createElement("button");
        delBtn.textContent = "Delete";
        delBtn.onclick = async () => {
          await sb.storage.from("user-uploads").remove([`${session.user.id}/${file.name}`]);
          loadFiles();
        };
        div.appendChild(delBtn);

        fileList.appendChild(div);
      }
    }

    // Initialize
    (async () => {
      const { data: { session } } = await sb.auth.getSession();
      if (!session) return window.location.href = "login.html";

      // Show email + profile initial
      const email = session.user.email;
      userEmail.textContent = email;
      profile.textContent = email[0].toUpperCase();

      loadFiles();
    })();
  </script>
</body>
</html>
