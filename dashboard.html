<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard</title>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    /* ------------------- YOUR ORIGINAL BASE STYLES (Kept as is or integrated) ------------------- */
    /* Note: Some original body/h1/file-card styles are overridden by new, more specific styles below for polish */
    body { font-family: Arial, sans-serif; max-width: 800px; margin: 40px auto; }
    h1 { text-align: center; }
    .file-card { border: 1px solid #ccc; padding: 10px; margin: 10px; display: inline-block; text-align: center; width: 180px; }
    img, video { max-width: 150px; max-height: 150px; display: block; margin: 0 auto 10px; }
    button { margin-top: 5px; }
    #settingsPanel { border:1px solid #ccc; padding:15px; margin:20px 0; background:#f9f9f9; display:none; }

    /* ------------------- NEW PROFESSIONAL POLISHING STYLES (Added) ------------------- */
    
    /* 1. Overall Page Layout & Typography */
    body {
        font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; /* Modern font stack */
        background-color: #e8eaf6; /* Soft, professional background */
        margin: 0;
        padding: 0;
        line-height: 1.6;
        color: #333;
    }

    .dashboard-container { /* Main wrapper to control overall width and centering */
        max-width: 1200px; /* Wider for gallery feel */
        margin: 20px auto;
        padding: 20px;
        background-color: #fff;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    }

    h1 {
        font-size: 2.5em;
        color: #1a237e; /* Deep blue */
        text-align: center;
        margin-bottom: 30px;
        font-weight: 600;
    }

    h2 {
        font-size: 1.8em;
        color: #3f51b5; /* Medium blue */
        border-bottom: 1px solid #c5cae9; /* Light blue border */
        padding-bottom: 10px;
        margin-top: 40px;
        margin-bottom: 20px;
    }

    /* 2. Top Controls (Settings & Logout) */
    .top-controls {
        display: flex;
        justify-content: flex-end;
        gap: 15px;
        margin-bottom: 30px;
    }

    /* 3. Button Styling (General) */
    button {
        padding: 12px 25px;
        border: none;
        border-radius: 6px;
        font-size: 1em;
        font-weight: 600;
        cursor: pointer;
        transition: background-color 0.3s ease, transform 0.2s ease;
        background-color: #5c6bc0; /* Indigo */
        color: white;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        margin-top: 0; /* Override original margin */
    }

    button:hover {
        background-color: #3f51b5; /* Darker indigo */
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }

    button:active {
        transform: translateY(0);
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }
    
    #logout {
        background-color: #ef5350; /* Red for logout */
    }

    #logout:hover {
        background-color: #e53935;
    }

    /* 4. Settings Panel */
    #settingsPanel {
        background: #fdfdfd;
        padding: 25px;
        border-radius: 10px;
        box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
        margin-top: 20px;
        margin-bottom: 30px;
    }

    #settingsPanel h2 {
        border-bottom: 1px solid #e0e0e0;
        padding-bottom: 10px;
        margin-top: 0;
        margin-bottom: 20px;
        color: #333;
    }

    #settingsPanel button, #settingsPanel a button {
        width: 100%;
        margin-bottom: 10px;
    }

    /* 5. Section Boxes (Upload & Camera) */
    .section-box {
        background: #fdfdfd;
        padding: 25px;
        border-radius: 10px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.06);
        margin-bottom: 30px;
    }

    /* 6. File Input Styling */
    input[type="file"] {
        display: block;
        margin-bottom: 15px;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 5px;
        background-color: #f0f0f0;
        width: calc(100% - 22px); /* Adjust for padding and border */
    }

    /* 7. Camera Feed */
    #camera {
        width: 100% !important; /* Make camera responsive within its container */
        height: auto !important;
        max-width: 320px; /* Keep original max-width */
        display: block;
        margin: 0 auto 20px;
        border: 2px solid #3f51b5 !important; /* Polished border */
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    /* 8. Google Photos Style Gallery (Images Smaller) */
    #fileList {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); /* Adjust min-width for smaller cards */
        gap: 20px; /* Space between items */
        margin-top: 20px;
    }

    .file-card {
        background-color: #fff;
        border: none; /* Remove default border */
        border-radius: 8px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08); /* More prominent shadow */
        overflow: hidden; /* Ensures content stays within rounded corners */
        display: flex;
        flex-direction: column;
        justify-content: space-between; /* Pushes delete button to bottom */
        transition: transform 0.2s ease;
        text-align: center;
        padding: 0; /* Remove padding from original */
        margin: 0; /* Remove margin from original */
    }

    .file-card:hover {
        transform: translateY(-3px); /* Subtle lift effect */
    }

    .file-card img, .file-card video {
        width: 100%; /* Fill card width */
        height: 160px; /* Fixed height for gallery look */
        object-fit: cover; /* Crop to fit, like Google Photos */
        display: block;
        margin: 0 0 10px 0; /* Adjust margin */
        border-bottom: 1px solid #eee;
    }

    .file-card a {
        color: #3f51b5;
        text-decoration: none;
        font-weight: 500;
        padding: 5px 10px;
        display: block; /* Make link a block for better click area */
        word-break: break-all; /* Prevents long file names from breaking layout */
    }

    .file-card a:hover {
        text-decoration: underline;
    }

    .file-card button {
        background-color: #ef5350; /* Red for delete button */
        margin-top: 10px; /* Space from link */
        border-radius: 0 0 8px 8px; /* Round bottom corners only */
        padding: 10px;
        width: 100%; /* Fill card width */
        box-shadow: none; /* No extra shadow */
    }

    .file-card button:hover {
        background-color: #e53935;
        transform: none; /* No lift on delete button */
    }

    /* Responsive adjustments for smaller screens */
    @media (max-width: 768px) {
        .dashboard-container {
            margin: 10px;
            padding: 15px;
        }
        h1 {
            font-size: 2em;
        }
        h2 {
            font-size: 1.5em;
        }
        .top-controls {
            flex-direction: column; /* Stack buttons on small screens */
            align-items: stretch;
        }
        button {
            width: 100%;
        }
        #fileList {
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); /* Even smaller cards on mobile */
        }
    }
  </style>
</head>
<body>
  <div class="dashboard-container"> 
    <h1>Dashboard</h1>

    <div class="top-controls"> 
        <button id="openSettingsBtn">Settings</button>
        <button id="logout">Logout</button>
    </div> 

    <div id="settingsPanel">
        <h2>Settings</h2>
        <button id="cameraPermissionBtn">Request Camera Access</button><br><br>

        <button id="toggleCameraBtn">Turn Camera Off</button><br><br>

        <a href="https://supabase.com/docs/guides/auth/auth-password-reset" target="_blank">
          <button>Change Password</button>
        </a><br><br>

        <p><strong>Storage Used:</strong> <span id="storageInfo">Loading...</span></p>

        <button id="closeSettingsBtn">Close</button>
    </div>

    <div class="section-box"> 
        <h2>Upload a File</h2>
        <input type="file" id="fileInput" />
        <button id="uploadBtn">Upload</button>
    </div> 

    <div class="section-box"> 
        <h2>Live Camera</h2>
        <video id="camera" autoplay playsinline width="320" height="240"></video> 
        <canvas id="canvas" width="320" height="240" style="display:none;"></canvas>
        <button id="captureBtn">Take Picture</button>
    </div> 

    <h2>Your Files</h2>
    <div id="fileList"></div>
  </div> 

  <script>
    const SUPABASE_URL = "https://ywivqcxjtvmztktwlepj.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl3aXZxY3hqdHZtenRrdHdsZXBqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE0NzA3NDksImV4cCI6MjA2NzA0Njc0OX0.4KUAOSRj4lnG_HCa-YNGeSReKT99qsEOgfrU9nmvh5s";

    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true },
    });

    const fileInput = document.getElementById("fileInput");
    const uploadBtn = document.getElementById("uploadBtn");
    const fileList = document.getElementById("fileList");
    const logoutBtn = document.getElementById("logout");

    function sanitize(name) {
      return name.replace(/[^a-zA-Z0-9._-]/g, "_");
    }

    logoutBtn.addEventListener("click", async () => {
      await sb.auth.signOut();
      window.location.href = "login.html";
    });

    uploadBtn.addEventListener("click", async () => {
      const file = fileInput.files[0];
      if (!file) return alert("Choose a file first");

      const { data: { session } } = await sb.auth.getSession();
      if (!session) return alert("Not logged in");

      const safeName = sanitize(file.name);
      const path = `${session.user.id}/${Date.now()}-${safeName}`;

      const { error } = await sb.storage.from("user-uploads").upload(path, file, { upsert: false });

      if (error) {
        alert("Upload failed: " + error.message);
      } else {
        alert("File uploaded!");
        loadFiles();
        loadStorageUsage();
      }
    });

    async function loadFiles() {
      const { data: { session } } = await sb.auth.getSession();
      if (!session) return;

      const { data, error } = await sb.storage.from("user-uploads").list(session.user.id, { limit: 100 });
      if (error) return console.error(error);

      fileList.innerHTML = "";

      for (const file of data) {
        const { data: signed } = await sb.storage
          .from("user-uploads")
          .createSignedUrl(`${session.user.id}/${file.name}`, 60 * 60);

        const div = document.createElement("div");
        div.className = "file-card";

        if (file.name.match(/\.(jpg|jpeg|png|gif|webp)$/i)) {
          const img = document.createElement("img");
          img.src = signed?.signedUrl || "";
          div.appendChild(img);
        }

        if (file.name.match(/\.(mp4|mov|avi|webm)$/i)) {
          const video = document.createElement("video");
          video.src = signed?.signedUrl || "";
          video.controls = true;
          div.appendChild(video);
        }

        const link = document.createElement("a");
        link.href = signed?.signedUrl || "#";
        link.textContent = file.name;
        link.target = "_blank";
        div.appendChild(link);

        const delBtn = document.createElement("button");
        delBtn.textContent = "Delete";
        delBtn.onclick = async () => {
          await sb.storage.from("user-uploads").remove([`${session.user.id}/${file.name}`]);
          loadFiles();
          loadStorageUsage();
        };
        div.appendChild(delBtn);

        fileList.appendChild(div);
      }
    }

    // ✅ Live camera setup
    const camera = document.getElementById("camera");
    const canvas = document.getElementById("canvas");
    const captureBtn = document.getElementById("captureBtn");

    let cameraStream = null;

    function startCamera() {
      navigator.mediaDevices.getUserMedia({ video: true })
        .then(stream => { 
          camera.srcObject = stream; 
          cameraStream = stream;
        })
        .catch(err => {
          console.error("Camera error:", err);
          alert("Camera access denied. Please allow it in browser settings.");
        });
    }

    function stopCamera() {
      if (cameraStream) {
        cameraStream.getTracks().forEach(track => track.stop());
        camera.srcObject = null;
        cameraStream = null;
      }
    }

    startCamera(); // start on load

    captureBtn.addEventListener("click", async () => {
      const ctx = canvas.getContext("2d");
      ctx.drawImage(camera, 0, 0, canvas.width, canvas.height);

      canvas.toBlob(async (blob) => {
        const file = new File([blob], `camera-${Date.now()}.png`, { type: "image/png" });

        const { data: { session } } = await sb.auth.getSession();
        if (!session) return alert("Not logged in");

        const path = `${session.user.id}/${file.name}`;
        const { error } = await sb.storage.from("user-uploads").upload(path, file);

        if (error) {
          alert("Upload failed: " + error.message);
        } else {
          loadFiles();
          loadStorageUsage();
          alert("Snapshot uploaded!");
        }
      }, "image/png");
    });

    // ✅ Settings panel logic
    const openSettingsBtn = document.getElementById("openSettingsBtn");
    const settingsPanel = document.getElementById("settingsPanel");
    const closeSettingsBtn = document.getElementById("closeSettingsBtn");
    const cameraPermissionBtn = document.getElementById("cameraPermissionBtn");
    const toggleCameraBtn = document.getElementById("toggleCameraBtn");
    const storageInfo = document.getElementById("storageInfo");

    openSettingsBtn.addEventListener("click", () => {
      settingsPanel.style.display = "block";
      loadStorageUsage();
    });

    closeSettingsBtn.addEventListener("click", () => {
      settingsPanel.style.display = "none";
    });

    cameraPermissionBtn.addEventListener("click", async () => {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        alert("✅ Camera access granted!");
        stream.getTracks().forEach(track => track.stop());
      } catch (err) {
        alert("❌ Camera access denied.");
      }
    });

    // ✅ Camera toggle
    toggleCameraBtn.addEventListener("click", () => {
      if (cameraStream) {
        stopCamera();
        toggleCameraBtn.textContent = "Turn Camera On";
      } else {
        startCamera();
        toggleCameraBtn.textContent = "Turn Camera Off";
      }
    });

    // ✅ Storage usage
    const MAX_STORAGE = 5 * 1024 * 1024 * 1024; // 5 GB total quota

    async function loadStorageUsage() {
      const { data: { session } } = await sb.auth.getSession();
      if (!session) return;

      const { data, error } = await sb.storage.from("user-uploads").list(session.user.id, { limit: 100 });
      if (error) return console.error(error);

      let totalBytes = 0;
      for (const file of data) {
        totalBytes += file.metadata?.size || 0;
      }

      const usedMB = (totalBytes / (1024*1024)).toFixed(2);
      const totalMB = (MAX_STORAGE / (1024*1024)).toFixed(0);
      storageInfo.textContent = `${usedMB} MB / ${totalMB} MB used`;
    }

    (async () => {
      const { data: { session } } = await sb.auth.getSession();
      if (!session) window.location.href = "login.html";
      else {
        loadFiles();
        loadStorageUsage();
      }
    })();
  </script>
</body>
</html>
