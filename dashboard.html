<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Dashboard</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        /* ------------------- BASE STYLES ------------------- */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f0f2f5;
            color: #333;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        h1, h2 { color: #222; margin-top: 0; }
        button {
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            background-color: #007bff;
            color: white;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        button:hover { background-color: #0056b3; }

        /* ------------------- TOP HEADER BAR ------------------- */
        .header-bar {
            background-color: #fff;
            padding: 15px 20px;
            border-bottom: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .header-bar .left-group, .header-bar .right-group {
            display: flex;
            align-items: center;
        }
        .welcome-message {
            font-size: 1.1em;
            font-weight: bold;
            margin-left: 20px;
            color: #555;
        }
        .settings-button-top {
            background-color: #6c757d;
        }
        .settings-button-top:hover {
            background-color: #5a6268;
        }
        #logout {
            background-color: #dc3545;
            margin-left: 10px;
        }
        #logout:hover {
            background-color: #c82333;
        }

        /* ------------------- SETTINGS PANEL ------------------- */
        #settingsPanel {
            position: fixed;
            top: 100px;
            right: 20px;
            width: 300px;
            background:#fff;
            border:1px solid #ccc;
            border-radius: 8px;
            padding:20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            z-index: 1000;
            display:none;
        }
        #settingsPanel h2 { margin-bottom: 15px; color: #333; }
        #settingsPanel button { margin-bottom: 10px; width: 100%; }
        #settingsPanel a button { background-color: #17a2b8; }
        #settingsPanel a button:hover { background-color: #138496; }
        #settingsPanel #closeSettingsBtn { background-color: #6c757d; margin-top: 15px; }

        /* ------------------- TAB NAVIGATION ------------------- */
        .tab-nav {
            display: flex;
            justify-content: center;
            background-color: #e9ecef;
            border-bottom: 2px solid #ced4da;
            padding: 0 20px;
        }

        .tab-button {
            padding: 12px 25px;
            cursor: pointer;
            background-color: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            font-size: 1.1em;
            font-weight: bold;
            color: #6c757d;
            transition: all 0.3s ease;
            text-decoration: none;
        }

        .tab-button:hover:not(.active) {
            color: #007bff;
            background-color: #f8f9fa;
        }

        .tab-button.active {
            color: #007bff;
            border-bottom: 3px solid #007bff;
            background-color: #fff;
        }

        /* ------------------- MAIN CONTENT AREA (DYNAMIC) ------------------- */
        .main-content-area {
            flex-grow: 1;
            background-color: #fff;
            padding: 30px 20px;
            margin: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.08);
            display: none;
            overflow-y: auto;
        }
        .main-content-area.active {
            display: block;
        }

        /* ------------------- GALLERY STYLES ------------------- */
        .file-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            padding-top: 15px;
        }

        .file-card {
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            overflow: hidden;
            text-align: center;
            display: flex;
            flex-direction: column;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .file-card img, .file-card video {
            width: 100%;
            height: 130px;
            object-fit: cover;
            margin-bottom: 8px;
        }

        .file-card a {
            padding: 0 8px 8px;
            word-break: break-all;
            display: block;
            font-size: 0.85em;
            color: #444;
            text-decoration: none;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .file-card a:hover { text-decoration: underline; }

        .file-card button {
            width: 100%;
            margin-top: auto;
            background-color: #dc3545;
            color: white;
            border-radius: 0 0 6px 6px;
            padding: 8px 0;
            border: none;
            font-size: 0.9em;
        }
        .file-card button:hover { background-color: #c82333; }

        /* ------------------- LIVE CAM STYLES ------------------- */
        .live-cam-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            background-color: #fcfcfc;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        #camera {
            width: 100%;
            height: auto;
            max-height: 400px;
            border:1px solid #ddd;
            background:#000;
            display: block;
            margin-bottom: 15px;
            border-radius: 4px;
        }
        #captureBtn, #fileInput, #uploadBtn {
            width: 100%;
            margin-bottom: 10px;
        }
        #fileInput {
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 5px;
            background-color: #fff;
            margin-top: 15px;
        }
        #uploadBtn { background-color: #28a745; }
        #uploadBtn:hover { background-color: #218838; }

        /* Canvas is always hidden but needs some size */
        #canvas { display:none; width: 320px; height: 240px; }

        /* ------------------- RESPONSIVE ADJUSTMENTS ------------------- */
        @media (max-width: 768px) {
            .header-bar { flex-direction: column; align-items: flex-start; }
            .header-bar .right-group { margin-top: 10px; width: 100%; justify-content: space-between; }
            .welcome-message { margin-left: 0; margin-top: 10px; }
            #openSettingsBtn, #logout { position: static; margin-left: 0; width: 48%; }
            #settingsPanel { top: 70px; right: 10px; left: 10px; width: auto; }
            .main-content-area { margin: 10px; padding: 15px; }
            .tab-button { padding: 10px 15px; font-size: 1em; }
            .file-grid { grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; }
            .file-card img, .file-card video { height: 90px; }
            .live-cam-container { padding: 15px; }
        }
    </style>
</head>
<body>
    <div class="header-bar">
        <div class="left-group">
            <h1 style="margin:0; font-size: 1.5em;">Dashboard</h1>
            <span id="userEmailDisplay" class="welcome-message">Welcome! Loading User...</span>
        </div>
        <div class="right-group">
            <button id="openSettingsBtn" class="settings-button-top">Settings</button>
            <button id="logout">Logout</button>
        </div>
    </div>

    <div id="settingsPanel">
        <h2>Settings</h2>
        <button id="cameraPermissionBtn">Request Camera Access</button><br>
        <button id="toggleCameraBtn">Turn Camera Off</button><br>
        <a href="https://supabase.com/docs/guides/auth/auth-password-reset" target="_blank">
            <button>Change Password</button>
        </a><br>
        <p><strong>Storage Used:</strong> <span id="storageInfo">Loading...</span></p>
        <button id="closeSettingsBtn">Close</button>
    </div>

    <div class="tab-nav">
        <button class="tab-button active" onclick="openTab(event, 'PhotosTab')">Photos</button>
        <button class="tab-button" onclick="openTab(event, 'LiveCamTab')">Live Cam</button>
        <button class="tab-button" onclick="openTab(event, 'VideosTab')">Videos</button>
    </div>

    <div id="PhotosTab" class="main-content-area active">
        <h2>Your Photos</h2>
        <div id="photoList" class="file-grid"></div>
    </div>

    <div id="LiveCamTab" class="main-content-area">
        <h2>Live Camera & Upload</h2>
        <div class="live-cam-container">
            <video id="camera" autoplay playsinline></video>
            <canvas id="canvas" style="display:none;"></canvas>
            <button id="captureBtn">Take Picture</button>

            <h3 style="margin-top: 25px; margin-bottom: 10px; color: #555;">Or Upload a File</h3>
            <input type="file" id="fileInput" />
            <button id="uploadBtn">Upload</button>
        </div>
    </div>

    <div id="VideosTab" class="main-content-area">
        <h2>Your Videos</h2>
        <div id="videoList" class="file-grid"></div>
    </div>

    <script>
        // Use document.addEventListener to ensure the DOM is fully loaded before trying to access elements
        document.addEventListener("DOMContentLoaded", () => {
            // 🛑 IMPORTANT: VERIFY YOUR SUPABASE KEYS ARE CORRECT 🛑
            const SUPABASE_URL = "https://ywivqcxjtvmztktwlepj.supabase.co"; 
            const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl3aXZxY3hqdHZmenRrdHdsZXBqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE0NzA3NDksImV4cCI6MjA2NzA0Njc0OX0.4KUAOSRj4lnG_HCa-YNGeSReKT99qsEOQeM_s";

            // Initialize Supabase Client
            const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
                auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true },
            });

            // Get all necessary DOM elements
            const fileInput = document.getElementById("fileInput");
            const uploadBtn = document.getElementById("uploadBtn");
            const logoutBtn = document.getElementById("logout");
            const photoList = document.getElementById("photoList");
            const videoList = document.getElementById("videoList");
            const userEmailDisplay = document.getElementById("userEmailDisplay");

            const camera = document.getElementById("camera");
            const canvas = document.getElementById("canvas");
            const captureBtn = document.getElementById("captureBtn");
            let cameraStream = null;

            const openSettingsBtn = document.getElementById("openSettingsBtn");
            const settingsPanel = document.getElementById("settingsPanel");
            const closeSettingsBtn = document.getElementById("closeSettingsBtn");
            const cameraPermissionBtn = document.getElementById("cameraPermissionBtn");
            const toggleCameraBtn = document.getElementById("toggleCameraBtn");
            const storageInfo = document.getElementById("storageInfo");
            const MAX_STORAGE = 5 * 1024 * 1024 * 1024; // 5 GB total quota


            // ------------------- TAB SWITCHING FUNCTIONALITY -------------------
            window.openTab = function(evt, tabName) {
                let i, tabcontent, tabbuttons;

                tabcontent = document.getElementsByClassName("main-content-area");
                for (i = 0; i < tabcontent.length; i++) {
                    tabcontent[i].classList.remove("active");
                }

                tabbuttons = document.getElementsByClassName("tab-button");
                for (i = 0; i < tabbuttons.length; i++) {
                    tabbuttons[i].classList.remove("active");
                }

                document.getElementById(tabName).classList.add("active");
                evt.currentTarget.classList.add("active");

                // Camera management
                if (tabName === 'LiveCamTab') {
                    startCamera();
                    toggleCameraBtn.textContent = "Turn Camera Off";
                } else {
                    stopCamera();
                    toggleCameraBtn.textContent = "Turn Camera On";
                }
            }
            // -------------------------------------------------------------------

            function sanitize(name) {
                return name.replace(/[^a-zA-Z0-9._-]/g, "_");
            }

            // ------------------- LOGOUT -------------------
            logoutBtn.addEventListener("click", async () => {
                await sb.auth.signOut();
                window.location.href = "login.html";
            });

            // ------------------- FILE UPLOAD -------------------
            uploadBtn.addEventListener("click", async () => {
                const file = fileInput.files[0];
                if (!file) return alert("Choose a file first");

                const { data: { session } } = await sb.auth.getSession();
                if (!session) return alert("Not logged in");

                const safeName = sanitize(file.name);
                const path = `${session.user.id}/${Date.now()}-${safeName}`;

                const { error } = await sb.storage.from("user-uploads").upload(path, file, { upsert: false });

                if (error) {
                    alert("Upload failed: " + error.message);
                } else {
                    alert("File uploaded!");
                    fileInput.value = ''; // Clear file input
                    loadFiles();
                    loadStorageUsage();
                }
            });

            // ------------------- FILE LOADING (PHOTOS/VIDEOS) -------------------
            async function loadFiles() {
                const { data: { session } } = await sb.auth.getSession();
                if (!session) return;

                const { data, error } = await sb.storage.from("user-uploads").list(session.user.id, { limit: 100 });
                if (error) return console.error(error);

                photoList.innerHTML = "";
                videoList.innerHTML = "";

                for (const file of data) {
                    const { data: signed } = await sb.storage
                        .from("user-uploads")
                        .createSignedUrl(`${session.user.id}/${file.name}`, 60 * 60);

                    const div = document.createElement("div");
                    div.className = "file-card";

                    let targetList;
                    let isMedia = false;

                    // Determine file type and target list
                    if (file.name.match(/\.(jpg|jpeg|png|gif|webp)$/i)) {
                        const img = document.createElement("img");
                        img.src = signed?.signedUrl || "";
                        div.appendChild(img);
                        targetList = photoList;
                        isMedia = true;
                    } else if (file.name.match(/\.(mp4|mov|avi|webm)$/i)) {
                        const video = document.createElement("video");
                        video.src = signed?.signedUrl || "";
                        video.controls = true;
                        div.appendChild(video);
                        targetList = videoList;
                        isMedia = true;
                    }

                    if (isMedia) {
                        const link = document.createElement("a");
                        link.href = signed?.signedUrl || "#";
                        link.textContent = file.name;
                        link.target = "_blank";
                        div.appendChild(link);

                        const delBtn = document.createElement("button");
                        delBtn.textContent = "Delete";
                        delBtn.onclick = async () => {
                            if (!confirm(`Are you sure you want to delete ${file.name}?`)) return;
                            await sb.storage.from("user-uploads").remove([`${session.user.id}/${file.name}`]);
                            loadFiles();
                            loadStorageUsage();
                        };
                        div.appendChild(delBtn);

                        targetList.appendChild(div);
                    }
                }
            }

            // ------------------- CAMERA LOGIC -------------------
            function startCamera() {
                if (cameraStream) return;

                navigator.mediaDevices.getUserMedia({ video: true })
                    .then(stream => {
                        camera.srcObject = stream;
                        cameraStream = stream;
                        camera.play();
                    })
                    .catch(err => {
                        console.error("Camera access failed:", err);
                        // Optional: Alert user that camera failed to start
                    });
            }

            function stopCamera() {
                if (cameraStream) {
                    cameraStream.getTracks().forEach(track => track.stop());
                    camera.srcObject = null;
                    cameraStream = null;
                }
            }

            captureBtn.addEventListener("click", async () => {
                if (!cameraStream) {
                    alert("Camera is off or access was denied. Please ensure camera is on and permissions are granted.");
                    return;
                }

                const ctx = canvas.getContext("2d");
                const width = camera.videoWidth;
                const height = camera.videoHeight;
                canvas.width = width;
                canvas.height = height;

                ctx.drawImage(camera, 0, 0, width, height);

                canvas.toBlob(async (blob) => {
                    const file = new File([blob], `camera-${Date.now()}.png`, { type: "image/png" });

                    const { data: { session } } = await sb.auth.getSession();
                    if (!session) return alert("Not logged in");

                    const path = `${session.user.id}/${file.name}`;
                    const { error } = await sb.storage.from("user-uploads").upload(path, file);

                    if (error) {
                        alert("Upload failed: " + error.message);
                    } else {
                        loadFiles();
                        loadStorageUsage();
                        alert("Snapshot uploaded!");
                    }
                }, "image/png");
            });

            // ------------------- SETTINGS & STORAGE LOGIC -------------------
            openSettingsBtn.addEventListener("click", () => {
                settingsPanel.style.display = "block";
                loadStorageUsage();
            });

            closeSettingsBtn.addEventListener("click", () => {
                settingsPanel.style.display = "none";
            });

            cameraPermissionBtn.addEventListener("click", async () => {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                    alert("✅ Camera access granted! You can now use the Live Cam tab.");
                    stream.getTracks().forEach(track => track.stop());
                } catch (err) {
                    alert("❌ Camera access denied. Check your browser settings.");
                }
            });

            toggleCameraBtn.addEventListener("click", () => {
                if (cameraStream) {
                    stopCamera();
                    toggleCameraBtn.textContent = "Turn Camera On";
                } else {
                    startCamera();
                    toggleCameraBtn.textContent = "Turn Camera Off";
                }
            });

            async function loadStorageUsage() {
                const { data: { session } } = await sb.auth.getSession();
                if (!session) {
                    storageInfo.textContent = "N/A (Not logged in)";
                    return;
                }

                const { data, error } = await sb.storage.from("user-uploads").list(session.user.id, { limit: 1000 });
                if (error) {
                    console.error("Error loading storage usage:", error);
                    storageInfo.textContent = "Error loading.";
                    return;
                }

                let totalBytes = 0;
                for (const file of data) {
                    // Supabase list() returns metadata with size for uploaded files
                    totalBytes += file.metadata?.size || 0;
                }

                const usedMB = (totalBytes / (1024 * 1024)).toFixed(2);
                const totalMB = (MAX_STORAGE / (1024 * 1024)).toFixed(0);
                storageInfo.textContent = `${usedMB} MB / ${totalMB} MB used`;
            }

            // ------------------- INITIALIZATION -------------------
            (async () => {
                const { data: { session } } = await sb.auth.getSession();
                if (!session) {
                    window.location.href = "login.html"; // Redirect to login if no session
                } else {
                    userEmailDisplay.textContent = `Welcome, ${session.user.email}!`;
                    loadFiles(); // Load files for the Photos and Videos tabs
                    loadStorageUsage(); // Load storage info for the Settings panel
                }
            })();
        });
    </script>
</body>
</html>
